<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pizzaria - Pedido</title>
</head>

<body>
    <div class="container">
        <!-- Formulário de busca de cliente -->
        <h2>Faça seu Pedido</h2>
        <div class="busca-cliente">
            <label for="cliente">Nome ou Telefone do Cliente</label>
            <input type="text" id="cliente" placeholder="Digite nome ou telefone">
            <button id="buscar-cliente">Buscar Cliente</button>
        </div>

        <!-- Se cliente for encontrado, mostra opções para selecionar pizzas -->
        <div id="seleciona-pizzas" class="oculto">
            <h3>Selecione as Pizzas</h3>
            <ul id="lista-pizzas"></ul>

            <!-- Lista de pizzas selecionadas -->
            <h3>Pedido</h3>
            <ul id="lista-pedido"></ul>
            <p>Total: <span id="total-pedido">R$ 0,00</span></p>
            <label for="forma-pagamento">Forma de Pagamento:</label>
            <select id="forma-pagamento">
                <option value="dinheiro">Dinheiro</option>
                <option value="cartao">Cartão</option>
                <option value="pix">PIX</option>
            </select>

            <button id="finalizar-pedido">Finalizar Pedido</button>
        </div>
    </div>

    <script>
        let pizzasSelecionadas = [];
        let total = 0;
        let codigoCliente = null;  // Armazena o código do cliente

        document.getElementById('buscar-cliente').addEventListener('click', buscarCliente);

        // Função para buscar o cliente
        async function buscarCliente() {
            const clienteInput = document.getElementById('cliente').value.trim();
        
            if (!clienteInput) {
                alert('Por favor, insira o nome ou telefone do cliente.');
                return;
            }
        
            // Limpa o código do cliente antes de buscar um novo
            codigoCliente = null;
        
            try {
                let url = '';
                if (/^\d{14}$/.test(clienteInput)) {
                    // Caso seja um telefone, faz a busca por telefone
                    url = `http://localhost:3000/clientes?telefone=${clienteInput}`;
                } else {
                    // Caso seja nome, tenta buscar por nome
                    url = `http://localhost:3000/clientes?nome=${clienteInput}`;
                }
        
                const response = await fetch(url);
                const clientes = await response.json();
        
                if (clientes.length === 0) {
                    alert('Cliente não encontrado. Verifique o nome ou telefone e tente novamente.');
                } else {
                    // Agora, procuramos o cliente que corresponde exatamente ao nome ou telefone buscado
                    let clienteEncontrado = null;
                    if (/^\d{14}$/.test(clienteInput)) {
                        // Se for um telefone, procura o cliente com o telefone exato
                        clienteEncontrado = clientes.find(c => c.telefone === clienteInput);
                    } else {
                        // Se for um nome, procura o cliente com o nome exato
                        clienteEncontrado = clientes.find(c => c.nome.toLowerCase() === clienteInput.toLowerCase());
                    }
        
                    if (clienteEncontrado) {
                        // Armazena o código do cliente encontrado
                        codigoCliente = clienteEncontrado.codigo;
                        alert(`Cliente encontrado! Código do cliente: ${codigoCliente}`);
                        document.getElementById('seleciona-pizzas').classList.remove('oculto');
                        carregarPizzas();  // Aqui pode ser carregado o formulário para selecionar pizzas
                    } else {
                        alert('Cliente não encontrado com esse nome ou telefone.');
                    }
                }
            } catch (error) {
                console.error('Erro ao buscar cliente:', error);
                alert('Erro ao buscar cliente.');
            }
        }
        

        // Função para carregar as pizzas
        async function carregarPizzas() {
            try {
                const response = await fetch('http://localhost:3000/pizzas');
                const pizzas = await response.json();

                const listaPizzas = document.getElementById('lista-pizzas');
                listaPizzas.innerHTML = '';

                pizzas.forEach(pizza => {
                    const preco = parseFloat(pizza.preco);
                    if (isNaN(preco)) {
                        console.error('Preço inválido para a pizza:', pizza.nome);
                        return;
                    }

                    const li = document.createElement('li');
                    li.classList.add('pizza-item');
                    li.innerHTML = `
                    <div>
                        <strong>${pizza.nome}</strong><br/> - <span class="preco">R$ ${preco.toFixed(2)}</span><br/>
                        <strong>Ingredientes: ${pizza.ingredientes}</strong><br/>
                        <img src="${pizza.nome_da_imagem}" alt="${pizza.nome}" class="pizza-imagem"/><br/>
                        <input type="number" min="1" value="1" id="quantidade-${pizza.codigo}" class="quantidade" />
                        <button data-pizza-id="${pizza.codigo}" class="adicionar-pedido">Adicionar ao Pedido</button>
                    </div>`;
                    listaPizzas.appendChild(li);
                });

                // Adiciona evento para cada botão de adicionar
                document.querySelectorAll('.adicionar-pedido').forEach(button => {
                    button.addEventListener('click', adicionarPizza);
                });
            } catch (error) {
                console.error('Erro ao carregar pizzas:', error);
            }
        }

        // Função para adicionar pizza ao pedido
        function adicionarPizza(e) {
            const pizzaId = e.target.getAttribute('data-pizza-id');
            const quantidade = parseInt(document.getElementById(`quantidade-${pizzaId}`).value);

            if (quantidade <= 0) {
                alert('Quantidade inválida!');
                return;
            }

            const pizzaNome = e.target.parentElement.querySelector('strong').textContent;
            const pizzaPreco = parseFloat(e.target.parentElement.querySelector('.preco').textContent.replace('R$ ', '').replace(',', '.'));

            pizzasSelecionadas.push({
                codigo_pizza: pizzaId,
                quantidade: quantidade
            });

            total += pizzaPreco * quantidade;
            document.getElementById('total-pedido').textContent = `R$ ${total.toFixed(2)}`;

            const pedidoItem = document.createElement('li');
            pedidoItem.textContent = `${pizzaNome} - R$ ${pizzaPreco.toFixed(2)} x ${quantidade}`;
            document.getElementById('lista-pedido').appendChild(pedidoItem);
        }

        // Finalizar o pedido
        document.getElementById('finalizar-pedido').addEventListener('click', async function () {
            if (pizzasSelecionadas.length === 0) {
                alert('Adicione pizzas ao pedido!');
                return;
            }

            if (codigoCliente === null) {
                alert('Selecione um cliente antes de finalizar o pedido.');
                return;
            }

            const formaDePagamento = document.getElementById('forma-pagamento').value;
            const dataHoraEntrega = new Date().toISOString();

            const pedido = {
                codigo_cliente: codigoCliente,
                pizzas: pizzasSelecionadas,
                forma_de_pagamento: formaDePagamento,
                data_hora_da_entrega: dataHoraEntrega
            };

            try {
                const response = await fetch('http://localhost:3000/api/pedido', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(pedido)
                });

                const result = await response.json();

                if (result.sucesso) {
                    alert(`Pedido realizado com sucesso! Código do pedido: ${result.codigo_pedido}`);
                    pizzasSelecionadas = [];
                    total = 0;
                    document.getElementById('total-pedido').textContent = 'R$ 0,00';
                    document.getElementById('lista-pedido').innerHTML = '';
                } else {
                    alert('Erro ao realizar o pedido.');
                }
            } catch (error) {
                console.error('Erro ao finalizar pedido:', error);
                alert('Erro ao finalizar o pedido.');
            }
        });
    </script>
</body>

</html>
